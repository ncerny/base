<%
    @netconf = 
      if ::File.exist?('/sys/bus/pci/drivers/mlx4_core')
        # Dell Poweredge Compute Nodes
        {
          infra_nic: 'eno1',
          match: 'driver: mlx4_en',
          parameters: {
            mode: 'balance-rr',
            'mii-monitor-interval': '100'
          }
        }
      elsif ::File.exist?('/sys/bus/pci/drivers/ixgbe')
        # Dell C6100 Storage Nodes
        {
          infra_nic: 'eno1',
          match: 'driver: ixgbe',
          parameters: {
            mode: '802.3ad',
            'lacp-rate': 'slow'
          }
        }
      else
        # Vagrant
        {
          infra_nic: 'eth0',
          match: 'name: eth1',
          parameters: {
            mode: 'balance-rr',
            'mii-monitor-interval': '100'
          }
        }
      end
-%>
network:
  version: 2
  renderer: networkd
  ethernets:
    <%= @netconf[:infra_nic] %>:
      dhcp4: yes
      dhcp6: no
      routes:
        - to: 192.168.10.0/24
          via: 192.168.10.1
          table: 101
      routing-policy:
        - from: 192.168.10.0/24
          table: 101
    switchports:
      mtu: 9000
      match:
        <%= @netconf[:match] %>
  bonds:
    bond0:
      dhcp4: yes
      dhcp6: yes
      mtu: 9000
      interfaces: [switchports]
      <%- if @netconf[:parameters] %>
      parameters:
      <%- @netconf[:parameters].each do |k,v| %>
        <%= k %>: <%= v %>
      <%- end %>
      <%- end %>
      routes:
        - to: 192.168.100.0/24
          via: 192.168.100.1
          table: 102
      routing-policy:
        - from: 192.168.100.0/24
          table: 102
  vlans:
    kc:
      id: 2
      link: bond0
      dhcp4: no
      dhcp6: no
